{"version":3,"sources":["deferred.js"],"names":["define","arrays","funcs","objects","async","slice","Array","prototype","proxy","makeArray","result","mixin","Promise","always","handler","this","then","done","i","arguments","length","fail","catch","Deferred","self","promise","makePromise2","resolve","reject","_resolve","_reject","isResolved","isPending","isRejected","v","e","state","notified","listeners","onResolved","onRejected","onProgress","progress","call","args","undefined","__ctx__","apply","forEach","value","push","pipe","notify","listener","error","notifyWith","ctx","resolveWith","context","_resolved","reason","rejectWith","_rejected","callback","errback","progback","p","all","array","d","bind","first","race","when","valueOrPromise","receivedPromise","nativePromise","deferred","cancel","err","immediate","data"],"mappings":"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","file":"../deferred.js","sourcesContent":["define([\r\n    \"skylark-langx-arrays\",\r\n\t\"skylark-langx-funcs\",\r\n    \"skylark-langx-objects\",\r\n    \"./async\"\r\n],function(arrays,funcs,objects,async){\r\n    \"use strict\";\r\n\r\n    var slice = Array.prototype.slice,\r\n        proxy = funcs.proxy,\r\n        makeArray = arrays.makeArray,\r\n        result = objects.result,\r\n        mixin = objects.mixin;\r\n\r\n    mixin(Promise.prototype,{\r\n        always: function(handler) {\r\n            //this.done(handler);\r\n            //this.fail(handler);\r\n            this.then(handler,handler);\r\n            return this;\r\n        },\r\n        done : function() {\r\n            for (var i = 0;i<arguments.length;i++) {\r\n                this.then(arguments[i]);\r\n            }\r\n            return this;\r\n        },\r\n        fail : function(handler) { define([\r\n    \"skylark-langx-arrays\",\r\n    \"skylark-langx-funcs\",\r\n    \"skylark-langx-objects\"\r\n],function(arrays,funcs,objects){\r\n    \"use strict\";\r\n\r\n    var slice = Array.prototype.slice,\r\n        proxy = funcs.proxy,\r\n        makeArray = arrays.makeArray,\r\n        result = objects.result,\r\n        mixin = objects.mixin;\r\n\r\n    mixin(Promise.prototype,{\r\n        always: function(handler) {\r\n            //this.done(handler);\r\n            //this.fail(handler);\r\n            this.then(handler,handler);\r\n            return this;\r\n        },\r\n        done : function() {\r\n            for (var i = 0;i<arguments.length;i++) {\r\n                this.then(arguments[i]);\r\n            }\r\n            return this;\r\n        },\r\n        fail : function(handler) { \r\n            //return mixin(Promise.prototype.catch.call(this,handler),added);\r\n            //return this.then(null,handler);\r\n            this.catch(handler);\r\n            return this;\r\n         }\r\n    });\r\n\r\n\r\n    var Deferred = function() {\r\n        var self = this,\r\n            p = this.promise = makePromise2(new Promise(function(resolve, reject) {\r\n                self._resolve = resolve;\r\n                self._reject = reject;\r\n            }));\r\n\r\n        //wrapPromise(p,self);\r\n\r\n        //this[PGLISTENERS] = [];\r\n        //this[PGNOTIFIES] = [];\r\n\r\n        //this.resolve = Deferred.prototype.resolve.bind(this);\r\n        //this.reject = Deferred.prototype.reject.bind(this);\r\n        //this.progress = Deferred.prototype.progress.bind(this);\r\n\r\n    };\r\n\r\n   \r\n    function makePromise2(promise) {\r\n        // Don't modify any promise that has been already modified.\r\n        if (promise.isResolved) return promise;\r\n\r\n        // Set initial state\r\n        var isPending = true;\r\n        var isRejected = false;\r\n        var isResolved = false;\r\n\r\n        // Observe the promise, saving the fulfillment in a closure scope.\r\n        var result = promise.then(\r\n            function(v) {\r\n                isResolved = true;\r\n                isPending = false;\r\n                return v; \r\n            }, \r\n            function(e) {\r\n                isRejected = true;\r\n                isPending = false;\r\n                throw e; \r\n            }\r\n        );\r\n\r\n        result.isResolved = function() { return isResolved; };\r\n        result.isPending = function() { return isPending; };\r\n        result.isRejected = function() { return isRejected; };\r\n\r\n        result.state = function() {\r\n            if (isResolved) {\r\n                return 'resolved';\r\n            }\r\n            if (isRejected) {\r\n                return 'rejected';\r\n            }\r\n            return 'pending';\r\n        };\r\n\r\n        var notified = [],\r\n            listeners = [];\r\n\r\n          \r\n        result.then = function(onResolved,onRejected,onProgress) {\r\n            if (onProgress) {\r\n                this.progress(onProgress);\r\n            }\r\n            return makePromise2(Promise.prototype.then.call(this,\r\n                onResolved && function(args) {\r\n                    if (args && args.__ctx__ !== undefined) {\r\n                        return onResolved.apply(args.__ctx__,args);\r\n                    } else {\r\n                        return onResolved(args);\r\n                    }\r\n                },\r\n                onRejected && function(args){\r\n                    if (args && args.__ctx__ !== undefined) {\r\n                        return onRejected.apply(args.__ctx__,args);\r\n                    } else {\r\n                        return onRejected(args);\r\n                    }\r\n                }\r\n            ));\r\n        };\r\n\r\n        result.progress = function(handler) {\r\n            notified.forEach(function (value) {\r\n                handler(value);\r\n            });\r\n            listeners.push(handler);\r\n            return this;\r\n        };\r\n\r\n        result.pipe = result.then;\r\n\r\n        result.notify = function(value) {\r\n            try {\r\n                notified.push(value);\r\n\r\n                return listeners.forEach(function (listener) {\r\n                    return listener(value);\r\n                });\r\n            } catch (error) {\r\n            this.reject(error);\r\n            }\r\n            return this;\r\n        };\r\n\r\n        result.notifyWith = function(ctx,value) {\r\n            try {\r\n                notified.push(value);\r\n\r\n                return listeners.forEach(function (listener) {\r\n                    return listener.call(ctx,value);\r\n                });\r\n            } catch (error) {\r\n            this.reject(error);\r\n            }\r\n            return this;\r\n        };\r\n                return result;\r\n    }\r\n\r\n \r\n    Deferred.prototype.resolve = function(value) {\r\n        var args = slice.call(arguments);\r\n        return this.resolveWith(null,args);\r\n    };\r\n\r\n    Deferred.prototype.resolveWith = function(context,args) {\r\n        args = args ? makeArray(args) : []; \r\n        args.__ctx__ = context;\r\n        this._resolve(args);\r\n        this._resolved = true;\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.notify = function(value) {\r\n        var p = result(this,\"promise\");\r\n        p.notify(value);\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.reject = function(reason) {\r\n        var args = slice.call(arguments);\r\n        return this.rejectWith(null,args);\r\n    };\r\n\r\n    Deferred.prototype.rejectWith = function(context,args) {\r\n        args = args ? makeArray(args) : []; \r\n        args.__ctx__ = context;\r\n        this._reject(args);\r\n        this._rejected = true;\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.isResolved = function() {\r\n        var p = result(this,\"promise\");\r\n        return p.isResolved();\r\n    };\r\n\r\n    Deferred.prototype.isRejected = function() {\r\n        var p = result(this,\"promise\");\r\n        return p.isRejected();\r\n    };\r\n\r\n    Deferred.prototype.state = function() {\r\n        var p = result(this,\"promise\");\r\n        return p.state();\r\n    };\r\n\r\n    Deferred.prototype.then = function(callback, errback, progback) {\r\n        var p = result(this,\"promise\");\r\n        return p.then(callback, errback, progback);\r\n    };\r\n\r\n    Deferred.prototype.progress = function(progback){\r\n        var p = result(this,\"promise\");\r\n        return p.progress(progback);\r\n    };\r\n   \r\n    Deferred.prototype.catch = function(errback) {\r\n        var p = result(this,\"promise\");\r\n        return p.catch(errback);\r\n    };\r\n\r\n\r\n    Deferred.prototype.always  = function() {\r\n        var p = result(this,\"promise\");\r\n        p.always.apply(p,arguments);\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.done  = function() {\r\n        var p = result(this,\"promise\");\r\n        p.done.apply(p,arguments);\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.fail = function(errback) {\r\n        var p = result(this,\"promise\");\r\n        p.fail(errback);\r\n        return this;\r\n    };\r\n\r\n\r\n    Deferred.all = function(array) {\r\n        //return wrapPromise(Promise.all(array));\r\n        var d = new Deferred();\r\n        Promise.all(array).then(d.resolve.bind(d),d.reject.bind(d));\r\n        return result(d,\"promise\");\r\n    };\r\n\r\n    Deferred.first = function(array) {\r\n        return makePromise2(Promise.race(array));\r\n    };\r\n\r\n\r\n    Deferred.when = function(valueOrPromise, callback, errback, progback) {\r\n        var receivedPromise = valueOrPromise && typeof valueOrPromise.then === \"function\";\r\n        var nativePromise = receivedPromise && valueOrPromise instanceof Promise;\r\n\r\n        if (!receivedPromise) {\r\n            if (arguments.length > 1) {\r\n                return callback ? callback(valueOrPromise) : valueOrPromise;\r\n            } else {\r\n                return new Deferred().resolve(valueOrPromise);\r\n            }\r\n        } else if (!nativePromise) {\r\n            var deferred = new Deferred(valueOrPromise.cancel);\r\n            valueOrPromise.then(proxy(deferred.resolve,deferred), proxy(deferred.reject,deferred), deferred.notify);\r\n            valueOrPromise = deferred.promise;\r\n        }\r\n\r\n        if (callback || errback || progback) {\r\n            return valueOrPromise.then(callback, errback, progback);\r\n        }\r\n        return valueOrPromise;\r\n    };\r\n\r\n    Deferred.reject = function(err) {\r\n        var d = new Deferred();\r\n        d.reject(err);\r\n        return d.promise;\r\n    };\r\n\r\n    Deferred.resolve = function(data) {\r\n        var d = new Deferred();\r\n        d.resolve.apply(d,arguments);\r\n        return d.promise;\r\n    };\r\n\r\n    Deferred.immediate = Deferred.resolve;\r\n\r\n\r\n    Deferred.promise = function(callback) {\r\n        var d = new Deferred();\r\n\r\n        callback(d.resolve.bind(d),d.reject.bind(d),d.progress.bind(d));\r\n\r\n        return d.promise;\r\n    };\r\n\r\n    return Deferred;\r\n});\r\n            //return mixin(Promise.prototype.catch.call(this,handler),added);\r\n            //return this.then(null,handler);\r\n            this.catch(handler);\r\n            return this;\r\n         }\r\n    });\r\n\r\n\r\n    var Deferred = function() {\r\n        var self = this,\r\n            p = this.promise = makePromise2(new Promise(function(resolve, reject) {\r\n                self._resolve = resolve;\r\n                self._reject = reject;\r\n            }));\r\n\r\n        //wrapPromise(p,self);\r\n\r\n        //this[PGLISTENERS] = [];\r\n        //this[PGNOTIFIES] = [];\r\n\r\n        //this.resolve = Deferred.prototype.resolve.bind(this);\r\n        //this.reject = Deferred.prototype.reject.bind(this);\r\n        //this.progress = Deferred.prototype.progress.bind(this);\r\n\r\n    };\r\n\r\n   \r\n    function makePromise2(promise) {\r\n        // Don't modify any promise that has been already modified.\r\n        if (promise.isResolved) return promise;\r\n\r\n        // Set initial state\r\n        var isPending = true;\r\n        var isRejected = false;\r\n        var isResolved = false;\r\n\r\n        // Observe the promise, saving the fulfillment in a closure scope.\r\n        var result = promise.then(\r\n            function(v) {\r\n                isResolved = true;\r\n                isPending = false;\r\n                return v; \r\n            }, \r\n            function(e) {\r\n                isRejected = true;\r\n                isPending = false;\r\n                throw e; \r\n            }\r\n        );\r\n\r\n        result.isResolved = function() { return isResolved; };\r\n        result.isPending = function() { return isPending; };\r\n        result.isRejected = function() { return isRejected; };\r\n\r\n        result.state = function() {\r\n            if (isResolved) {\r\n                return 'resolved';\r\n            }\r\n            if (isRejected) {\r\n                return 'rejected';\r\n            }\r\n            return 'pending';\r\n        };\r\n\r\n        var notified = [],\r\n            listeners = [];\r\n\r\n          \r\n        result.then = function(onResolved,onRejected,onProgress) {\r\n            if (onProgress) {\r\n                this.progress(onProgress);\r\n            }\r\n            return makePromise2(Promise.prototype.then.call(this,\r\n                onResolved && function(args) {\r\n                    if (args && args.__ctx__ !== undefined) {\r\n                        return onResolved.apply(args.__ctx__,args);\r\n                    } else {\r\n                        return onResolved(args);\r\n                    }\r\n                },\r\n                onRejected && function(args){\r\n                    if (args && args.__ctx__ !== undefined) {\r\n                        return onRejected.apply(args.__ctx__,args);\r\n                    } else {\r\n                        return onRejected(args);\r\n                    }\r\n                }\r\n            ));\r\n        };\r\n\r\n        result.progress = function(handler) {\r\n            notified.forEach(function (value) {\r\n                handler(value);\r\n            });\r\n            listeners.push(handler);\r\n            return this;\r\n        };\r\n\r\n        result.pipe = result.then;\r\n\r\n        result.notify = function(value) {\r\n            try {\r\n                notified.push(value);\r\n\r\n                return listeners.forEach(function (listener) {\r\n                    return listener(value);\r\n                });\r\n            } catch (error) {\r\n            this.reject(error);\r\n            }\r\n            return this;\r\n        };\r\n\r\n        return result;\r\n    }\r\n\r\n \r\n    Deferred.prototype.resolve = function(value) {\r\n        var args = slice.call(arguments);\r\n        return this.resolveWith(null,args);\r\n    };\r\n\r\n    Deferred.prototype.resolveWith = function(context,args) {\r\n        args = args ? makeArray(args) : []; \r\n        args.__ctx__ = context;\r\n        this._resolve(args);\r\n        this._resolved = true;\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.notify = function(value) {\r\n        var p = result(this,\"promise\");\r\n        p.notify(value);\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.reject = function(reason) {\r\n        var args = slice.call(arguments);\r\n        return this.rejectWith(null,args);\r\n    };\r\n\r\n    Deferred.prototype.rejectWith = function(context,args) {\r\n        args = args ? makeArray(args) : []; \r\n        args.__ctx__ = context;\r\n        this._reject(args);\r\n        this._rejected = true;\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.isResolved = function() {\r\n        var p = result(this,\"promise\");\r\n        return p.isResolved();\r\n    };\r\n\r\n    Deferred.prototype.isRejected = function() {\r\n        var p = result(this,\"promise\");\r\n        return p.isRejected();\r\n    };\r\n\r\n    Deferred.prototype.state = function() {\r\n        var p = result(this,\"promise\");\r\n        return p.state();\r\n    };\r\n\r\n    Deferred.prototype.then = function(callback, errback, progback) {\r\n        var p = result(this,\"promise\");\r\n        return p.then(callback, errback, progback);\r\n    };\r\n\r\n    Deferred.prototype.progress = function(progback){\r\n        var p = result(this,\"promise\");\r\n        return p.progress(progback);\r\n    };\r\n   \r\n    Deferred.prototype.catch = function(errback) {\r\n        var p = result(this,\"promise\");\r\n        return p.catch(errback);\r\n    };\r\n\r\n\r\n    Deferred.prototype.always  = function() {\r\n        var p = result(this,\"promise\");\r\n        p.always.apply(p,arguments);\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.done  = function() {\r\n        var p = result(this,\"promise\");\r\n        p.done.apply(p,arguments);\r\n        return this;\r\n    };\r\n\r\n    Deferred.prototype.fail = function(errback) {\r\n        var p = result(this,\"promise\");\r\n        p.fail(errback);\r\n        return this;\r\n    };\r\n\r\n\r\n    Deferred.all = function(array) {\r\n        //return wrapPromise(Promise.all(array));\r\n        var d = new Deferred();\r\n        Promise.all(array).then(d.resolve.bind(d),d.reject.bind(d));\r\n        return result(d,\"promise\");\r\n    };\r\n\r\n    Deferred.first = function(array) {\r\n        return makePromise2(Promise.race(array));\r\n    };\r\n\r\n\r\n    Deferred.when = function(valueOrPromise, callback, errback, progback) {\r\n        var receivedPromise = valueOrPromise && typeof valueOrPromise.then === \"function\";\r\n        var nativePromise = receivedPromise && valueOrPromise instanceof Promise;\r\n\r\n        if (!receivedPromise) {\r\n            if (arguments.length > 1) {\r\n                return callback ? callback(valueOrPromise) : valueOrPromise;\r\n            } else {\r\n                return new Deferred().resolve(valueOrPromise);\r\n            }\r\n        } else if (!nativePromise) {\r\n            var deferred = new Deferred(valueOrPromise.cancel);\r\n            valueOrPromise.then(proxy(deferred.resolve,deferred), proxy(deferred.reject,deferred), deferred.notify);\r\n            valueOrPromise = deferred.promise;\r\n        }\r\n\r\n        if (callback || errback || progback) {\r\n            return valueOrPromise.then(callback, errback, progback);\r\n        }\r\n        return valueOrPromise;\r\n    };\r\n\r\n    Deferred.reject = function(err) {\r\n        var d = new Deferred();\r\n        d.reject(err);\r\n        return d.promise;\r\n    };\r\n\r\n    Deferred.resolve = function(data) {\r\n        var d = new Deferred();\r\n        d.resolve.apply(d,arguments);\r\n        return d.promise;\r\n    };\r\n\r\n    Deferred.immediate = Deferred.resolve;\r\n\r\n\r\n    Deferred.promise = function(callback) {\r\n        var d = new Deferred();\r\n\r\n        callback(d.resolve.bind(d),d.reject.bind(d),d.progress.bind(d));\r\n\r\n        return d.promise;\r\n    };\r\n\r\n    return async.Deferred = Deferred;\r\n});"]}